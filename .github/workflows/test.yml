name: Tests

on: [push, pull_request]

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-latest, windows-latest]
    defaults:
      run:
        shell: bash
    runs-on: ${{ matrix.os }}
    steps:
    - name: Check out repository code
      uses: actions/checkout@v4
    - name: 💾 Cache dependencies on Windows
      if: runner.os == 'Windows'
      uses: actions/cache@v4
      with:
        path: |
          C:\msys64\var\cache\pacman\pkg
          C:\vcpkg\installed
        key: build-dep-windows
    - name: 💾 Cache dependencies on MacOS
      if: runner.os == 'macOS'
      uses: actions/cache@v4
      with:
        path: ~/Library/Caches/Homebrew/downloads
        key: build-dep-macos
    - name: 🍺 Install dependencies on MacOS
      if: runner.os == 'macOS'
      run: env HOMEBREW_NO_AUTO_UPDATE=1 brew install allegro scons
    - name: 🐧 Install dependencies on Linux
      if: runner.os == 'Linux'
      run: |
        sudo apt-get install -qq -y -o=Dpkg::Use-Pty=0 liballegro5-dev scons
    - name: Setup MSVC
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1
    - name: 🔍 Add MSYS2 to path on Windows
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        echo "C:\msys64\usr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "C:\msys64\ucrt64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    - name: 🪟 Install msys2 dependencies on Windows
      if: runner.os == 'Windows'
      run: |
        pacman --noconfirm -S mingw-w64-ucrt-x86_64-gcc mingw-w64-ucrt-x86_64-scons mingw-w64-ucrt-x86_64-allegro mingw-w64-ucrt-x86_64-pkgconf
    - name: 🪟 Set up environment variables on Windows
      if: runner.os == 'Windows'
      run: |
        echo "VCPKG_ROOT=C:/vcpkg" >> $GITHUB_ENV
        echo "MSYSTEM=UCRT64" >> $GITHUB_ENV
    - name: 🪟 Install vcpkg dependencies on Windows
      if: runner.os == 'Windows'
      run: vcpkg install allegro5
    - name: ⚒ Build static with Visual Studio on Windows
      if: runner.os == 'Windows'
      run: scons -j 1
    - name: ⚒ Build shared with Visual Studio on Windows
      if: ${{ runner.os == 'Windows' && !cancelled() }}
      run: |
        scons -j 1 build_shared=1
        sed -i "s/env = Environment(ENV = os.environ)/env = Environment(tools=['mingw'], ENV = os.environ)/" SConstruct
    - name: ⚒ Build static
      if: ${{ !cancelled() }}
      run: scons -j 1
    - name: ⚒ Build shared
      if: ${{ !cancelled() }}
      run: scons -j 1 build_shared=1
