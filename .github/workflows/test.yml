name: Tests

on: [push, pull_request]

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-latest, windows-latest]
    defaults:
      run:
        shell: bash
    runs-on: ${{ matrix.os }}
    steps:
    - name: Check out repository code
      uses: actions/checkout@v4
    - name: ðŸ’¾ Cache dependencies on Windows
      if: runner.os == 'Windows'
      uses: actions/cache@v4
      with:
        path: |
          C:\msys64\var\cache\pacman\pkg
          C:\vcpkg\installed
        key: build-dep-windows
    - name: ðŸ’¾ Cache dependencies on MacOS
      if: runner.os == 'macOS'
      uses: actions/cache@v4
      with:
        path: ~/Library/Caches/Homebrew/downloads
        key: build-dep-macos
    - name: ðŸ’¾ Cache ImageMagick 7 on Ubuntu
      id: imagemagick
      if: runner.os == 'Linux'
      uses: actions/cache@v4
      with:
        path: |
          /usr/local/bin/magick
          squashfs-root
        key: magick-linux
    - name: ðŸº Install dependencies on MacOS
      if: runner.os == 'macOS'
      run: env HOMEBREW_NO_AUTO_UPDATE=1 brew install allegro scons imagemagick
    - name: ðŸ§ Install dependencies on Linux
      if: runner.os == 'Linux'
      run: sudo apt-get install -qq -y -o=Dpkg::Use-Pty=0 liballegro5-dev scons
    - name: ðŸ§ Setup ImageMagick 7 on Linux
      if: runner.os == 'Linux' && steps.imagemagick.outputs.cache-hit != 'true'
      run: |
        wget -q --show-progress https://imagemagick.org/archive/binaries/magick
        chmod +x magick
        ./magick --appimage-extract
        sudo ln -s $PWD/squashfs-root/usr/bin/magick /usr/local/bin/magick
    - name: Setup MSVC
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1
    - name: ðŸ” Add MSYS2 to path on Windows
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        echo "C:\msys64\usr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "C:\msys64\ucrt64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    - name: ðŸªŸ Install msys2 dependencies on Windows
      if: runner.os == 'Windows'
      run: >-
        pacman --noconfirm -S
        mingw-w64-ucrt-x86_64-gcc
        mingw-w64-ucrt-x86_64-scons
        mingw-w64-ucrt-x86_64-allegro
        mingw-w64-ucrt-x86_64-pkgconf
        mingw-w64-ucrt-x86_64-imagemagick
    - name: ðŸªŸ Set up environment variables on Windows
      if: runner.os == 'Windows'
      run: |
        echo "VCPKG_ROOT=C:/vcpkg" >> $GITHUB_ENV
        echo "MSYSTEM=UCRT64" >> $GITHUB_ENV
    - name: ðŸªŸ Install vcpkg dependencies on Windows
      if: runner.os == 'Windows'
      run: |
        vcpkg install allegro5
        choco install imagemagick
    - name: âš’ Build static with Visual Studio on Windows
      if: runner.os == 'Windows'
      run: scons -j 1
    - name: ðŸš€ Run tests for Visual Studio build
      if: ${{ runner.os == 'Windows' && !cancelled() }}
      run: scons check
    - name: âš’ Build shared with Visual Studio on Windows
      if: ${{ runner.os == 'Windows' && !cancelled() }}
      run: |
        scons -j 1 build_shared=1
        sed -i "s/env = Environment(ENV = os.environ)/env = Environment(tools=['mingw'], ENV = os.environ)/" SConstruct
    - name: âš’ Build static
      if: ${{ !cancelled() }}
      run: scons -j 1
    - name: ðŸš€ Run tests
      if: ${{ !cancelled() }}
      run: scons check
    - name: âš’ Build shared
      if: ${{ !cancelled() }}
      run: scons -j 1 build_shared=1
